---
title: 'How to Deploy Static Site to GCP Cloud Run'
date: '2021-08-25'
tags: ['CI/CD', 'Docker', 'GCP', 'Nginx']
description: 'ç´€éŒ„å¦‚ä½•é€é multi-stage build çš„æ–¹å¼å°‡éœæ…‹ç¶²ç«™æ‰“åŒ…æˆ Docker imageï¼Œæ¥è‘—æ•´åˆ Github å’Œ Cloud Build Trigger è‡ªå‹•å»ºç½®å¾Œéƒ¨ç½²è‡³ Cloud Run é‹è¡Œã€‚'
---

## Table of Contents

```toc

```

## 1. æ’°æ–‡å‹•æ©Ÿ

ç­†è€…æ›¾ç¶“å”åŠ©éå€å¡Šéˆå·¥ç¨‹å¸«è£½ä½œ landing pageï¼Œä¸éç•¶æ™‚åƒ…ä½¿ç”¨ Vue é€²è¡Œ UI çš„ç°¡å–®é–‹ç™¼ï¼Œæ²’æœ‰æ‰“åŒ… Docker image å°±ç›´æ¥è½‰äº¤ä»–äººé€²è¡Œéƒ¨ç½²äº†ã€‚æ°å¥½æœ€è¿‘éœ€è¦ç·´ç¿’ Nginxã€Dockerã€Google Cloud Platform ç­‰å‰ç«¯å·¥ç¨‹å¸«è¼ƒå°‘æ¥è§¸çš„é ˜åŸŸï¼Œæ‰€ä»¥æŠŠ[ç•¶å¹´çš„å°ˆæ¡ˆ](https://github.com/YogaPan/vue-landing-page)ç¿»å‡ºä¾†ï¼Œä½¿ç”¨ä¸Šè¿°æŠ€è¡“é€²è¡Œéƒ¨ç½²ç·´ç¿’ã€‚

## 2. Nginx

ç”±æ–¼ä¸éœ€è¦è™•ç† WebAPI è«‹æ±‚ï¼Œæ‰€ä»¥æˆ‘å€‘ç›´æ¥ä½¿ç”¨ [Nginx](http://nginx.org/en/) ä½œç‚ºéœæ…‹è³‡æº web serverï¼Œé‡å° HTTP request å›æ‡‰å°æ‡‰çš„éœæ…‹è³‡æºï¼Œä¸¦é€²è¡Œ cacheã€compression å£“ç¸®ç­‰è™•ç†ï¼Œåœ¨è¨­å®šä¸Šæœ‰è¨±å¤šçœ‰çœ‰è§’è§’ï¼Œä»¥ä¸‹æˆ‘å€‘å°±ä¸€ä¸€æ‹†è§£ã€‚

### 2.1 Handle Request URL

è¨­å®š [listen](http://nginx.org/en/docs/http/ngx_http_core_module.html#listen) ã€ [root](http://nginx.org/en/docs/http/ngx_http_core_module.html#root) ä»¥åŠ [location](http://nginx.org/en/docs/http/ngx_http_core_module.html#location) ï¼Œæ ¹æ“š request URL å›æ‡‰å°æ‡‰è·¯å¾‘çš„æª”æ¡ˆã€‚è‹¥ç‚º SPAï¼Œå‰‡éœ€è¦è¨­å®š [try_files](http://nginx.org/en/docs/http/ngx_http_core_module.html#try_files) é€²è¡Œå…§éƒ¨é‡æ–°å°å‘è‡³ `index.html`ï¼Œå°‡æ±ºå®šé é¢æ¸²æŸ“çš„é‚è¼¯äº¤ç”±å‰ç«¯çš„ [History API](https://developer.mozilla.org/en-US/docs/Web/API/History_API) ä¾†æ±ºå®šï¼š

```nginx
server {
  listen $PORT; # åœ¨ Nginx image å…§æ³¨å…¥çš„ç’°å¢ƒè®Šæ•¸ï¼Œå¾Œé¢ç« ç¯€æœƒæåˆ°ã€‚
  root /usr/share/nginx/html;
  location / {
    try_files $uri /index.html;
  }
}
```

éœ€è¦ç‰¹åˆ¥æ³¨æ„ `.` é–‹é ­çš„ hidden file é€šå¸¸ä¸å¸Œæœ›èƒ½è¢«å­˜å–ï¼Œç‚ºä¿éšªèµ·è¦‹åŠ ä¸Š [deny](http://nginx.org/en/docs/http/ngx_http_access_module.html#deny) è¦å‰‡ï¼š

```nginx
server {
  location ~ /\. {
    deny all;
  }
}
```

### 2.2 Compression

åˆ©ç”¨ [ngx_http_gzip_module](http://nginx.org/en/docs/http/ngx_http_gzip_module.html) é‡å° text-based çš„æª”æ¡ˆé€²è¡Œå£“ç¸®ï¼š

```nginx
server {
  # é è¨­åƒ…é–‹å•Ÿ `text/html` MIME Types Response çš„å£“ç¸®
  gzip on;
  # æŒ‡å®šé™¤ `text/html` ä»¥å¤–ä¹Ÿéœ€è¢«å£“ç¸®çš„ MIME types response
  gzip_types text/plain text/css text/xml text/javascript application/javascript  application/xml;
  # add `Vary: Accept-Encoding` header
  # reference: https://developer.mozilla.org/en-US/docs/Web/HTTP/Caching#varying_responses
  gzip_vary on;
  # compression level, 1 ~ 9 å¯ä¾›é¸æ“‡
  gzip_comp_level 1;
  # æ ¹æ“š response header `Content-Length` æ±ºå®šæ˜¯å¦é€²è¡Œå£“ç¸®
  gzip_min_length 10240;
}
```

åœ¨ Devtool ä¸­å¯ä»¥çœ‹ Gzip ç‚ºæˆ‘å€‘ç¯€çœäº†è¨±å¤šç¶²è·¯æµé‡ï¼š

![nginx gzip](../images/gcp-static-site/nginx-gzip.png)

### 2.3 HTTP Cache

é‡å° [webpack long-term cache](https://developers.google.com/web/fundamentals/performance/webpack/use-long-term-caching#split-the-code-into-routes-and-pages) ç”¢å‡ºçš„ `css/js/image` è¨­å®šæ¥µé•·çš„ [expires](http://nginx.org/en/docs/http/ngx_http_headers_module.html#expires) ï¼Œåˆ©ç”¨ cache é”åˆ°å¢é€²æ•ˆèƒ½ã€æ¸›å°‘ server ç¶²è·¯æµé‡çš„æ•ˆæœï¼š

```nginx
server {
  location ~* \.(css|js)$ {
    expires 365d;
  }

  location ~* \.(jpg|jpeg|png|gif)$ {
    expires 365d;
  }
}
```

![nginx cache](../images/gcp-static-site/nginx-cache.png)

ä»¥ä¸Šåƒ…æ˜¯å¾ˆåŸºæœ¬çš„è¨­å®šï¼Œè‹¥è¦å°æ•ˆèƒ½é€²è¡Œèª¿æ ¡ã€æ”¹å–„é–‹ç™¼ç’°å¢ƒï¼Œå¯ä»¥åƒè€ƒä»¥ä¸‹é€£çµï¼š

1. [GitHub - denji/nginx-tuning: NGINX tuning for best performance](https://github.com/denji/nginx-tuning)
2. [Github - Sample Nginx config with sane caching settings for modern web development](https://gist.github.com/philipstanislaus/654adafad91efb6de230845b5bdeae61)

## 3. Docker

[Docker](https://www.docker.com/) å”åŠ©å»ºç½®ã€æ¸¬è©¦ä¸¦ä¸”æ‰“åŒ…æˆä¸€å€‹ç¨ç«‹ç¶²é æ‡‰ç”¨ï¼Œåªéœ€å»ºç½®ä¸€æ¬¡ Docker imageï¼Œå³å¯åœ¨ä»»æ„æ©Ÿå™¨ã€å¹³å°ã€æœå‹™ä¸ŠåŸ·è¡Œï¼Œé¿å…ç’°å¢ƒè¨­å®šã€å¥—ä»¶å®‰è£ç­‰ç¹é›œå·¥ä½œã€‚

### 3.1 Dockerfile

æ’°å¯« `Dockerfile` å¼·çƒˆå»ºè­°è¦çœ‹éé€™ç¯‡ [Intro Guide to Dockerfile Best Practices](https://www.docker.com/blog/intro-guide-to-dockerfile-best-practices/) ï¼Œæ­£ç¢ºçš„æ’°å¯«æ–¹å¼å¯ä»¥ä½¿ç”¨ cache å¤§å¤§æ¸›å°‘ build timeï¼Œä¹Ÿæ¸›å°‘ image size é¿å…ä¸å¿…è¦çš„ç¶²è·¯å‚³è¼¸ã€‚

é€™è£¡éœ€è¦å…©å€‹ Base Imageï¼Œç”¨ [multi-stage](https://docs.docker.com/develop/develop-images/multistage-build/) çš„æ–¹å¼é€²è¡Œ docker buildï¼š

1. [Node image](https://hub.docker.com/_/node) ï¼šç”¨ä¾†å®‰è£ç›¸ä¾å¥—ä»¶ï¼Œæ¸¬è©¦å¾Œç”¢å‡º `dist`ã€‚
2. [Nginx image](https://hub.docker.com/_/nginx) ï¼šå°‡ `dist`ã€`nginx.conf` copy è‡³ Nginx æœƒè®€å–çš„ folder åº•ä¸‹ï¼Œä¸¦è¨­å®šç›£è½ port è™Ÿã€‚

```Dockerfile
FROM node:16.5 as builder

WORKDIR /app

COPY package.json yarn.lock ./
RUN yarn install --frozen-lockfile

COPY . .
RUN yarn lint && yarn test && yarn build

FROM nginx:1.21.1-alpine as prod
ARG REVISION_ID
LABEL revision_id=${REVISION_ID}

COPY nginx/nginx.conf /etc/nginx/templates/default.conf.template
COPY --from=builder /app/dist /usr/share/nginx/html

ENV REVISION_ID=${REVISION_ID}
```

ä»¥ä¸Š `Dockerfile` æœ‰å¹¾å€‹å°ç´°ç¯€ï¼š

1. `REVISION_ID`ï¼šä½œç‚º debug ç”¨é€”ï¼Œå¯ä»¥å¿«é€Ÿæ‰¾å‡ºé€™é¡† image å°æ‡‰çš„ git commitã€‚
2. å°‡ `nginx.conf` copy è‡³ `/etc/nginx/templates` åº•ä¸‹ï¼šç•¶ container å•Ÿå‹•æ™‚æœƒå°‡**ç’°å¢ƒè®Šæ•¸**æ³¨å…¥ `/etc/nginx/templates` åº•ä¸‹çš„è¨­å®šæª”å¾Œæ¬ç§»è‡³ `/etc/nginx/conf.d/` ä¸­ã€‚æˆ‘å€‘åœ¨å‰é¢å·²ç¶“åœ¨ `nginx.conf` ä¸­æœ‰æŒ‡å®šç›£è½ `PORT` é€™å€‹ç’°å¢ƒè®Šæ•¸ã€‚

### 3.2 Build Docker Image

åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤å»ºç½® docker imageï¼š

```shell
docker build \
  --build-arg REVISION_ID="$(git log -1 --format=%H)" \
  --tag galtz/vue-landing-page \
  .
```

é‡è¤‡åŸ·è¡Œæ™‚ Docker build æœƒä½¿ç”¨ cacheï¼Œåªè¦ä¸ä¿®æ”¹ `package.json` å°±ä¸æœƒåŸ·è¡Œ `yarn install`ï¼Œç¯€çœäº†ä¸å°‘æ™‚é–“ï¼

![docker build](../images/gcp-static-site/docker-cache.png)

Run Docker imageï¼š

```shell
docker run \
  -dp 8080:8080 -e "PORT=8080" \
  --name vue-landing-page \
  galtz/vue-landing-page
```

### 3.3 Build Scripts

æ¯æ¬¡éƒ½éœ€è¦æ‰“é€™ä¸€å¤§ä¸²æŒ‡ä»¤ç›¸ç•¶ä¸ç›´è¦ºä¹Ÿè¶…éº»ç…©ï¼Œé€™è£¡ç¨ä½œæ•´ç†å°‡ build image æ‰€éœ€è¦æª”æ¡ˆå’Œè…³æœ¬æ•´ç†å¦‚ä¸‹ï¼š

```text
vue-landing-page/
â”œâ”€â”€ build/
â”‚   â”œâ”€â”€ build-image.properties
â”‚   â””â”€â”€ Dockerfile
â””â”€â”€â”€ scripts/
    â”œâ”€â”€ build-image.sh
    â””â”€â”€ run-image.sh
```

å°‡æœªä¾†å¯èƒ½éœ€è¦é€²è¡Œèª¿æ•´çš„ image name æ”¾å…¥ `build/build-image.properties` ä¸­ï¼š

```properties
IMAGE_NAME=galtz/vue-landing-page
```

`scripts/build-image.sh`ï¼š

```shell
#!/bin/bash

set -ex

REVISION_ID="$(git log -1 --format=%H)"
SH_DIR="$(cd "$(dirname "$0")"; pwd -P)"
ROOT_DIR="$(dirname $SH_DIR)"
BUILD_DIR="${ROOT_DIR}/build"
DOCKERFILE="${BUILD_DIR}/Dockerfile"

source ${BUILD_DIR}/build-image.properties

docker build \
  --build-arg REVISION_ID=${REVISION_ID} \
  --tag ${IMAGE_NAME} \
  --file ${DOCKERFILE} \
  $ROOT_DIR
```

é€™é‚Šæœ‰ä¸€å€‹ shell script çš„å°è¨£ç«…ï¼š `set -ex`ï¼Œ`-e` ä»£è¡¨æœ‰æŸä¸€æ¢æŒ‡ä»¤å¤±æ•—äº†å°±ä¸æœƒç¹¼çºŒå¾€ä¸‹åŸ·è¡Œï¼› `-x` å‰‡æ˜¯å°å‡ºæ¯æ¢æŒ‡ä»¤å’Œè®Šæ•¸ï¼Œdebug èµ·ä¾†ç‰¹åˆ¥æ–¹ä¾¿ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š
![shell script](../images/gcp-static-site/shell-script.png)

`scripts/run-image.sh`ï¼š

```shell
#!/bin/bash

set -ex

SH_DIR="$(cd "$(dirname "$0")"; pwd -P)"
ROOT_DIR=$(dirname $SH_DIR)
BUILD_DIR=$ROOT_DIR/build
CONTAINER_NAME=vue-landing-page
PORT=8080

source $BUILD_DIR/build-image.properties

docker run \
  -dp ${PORT}:${PORT} -e "PORT=${PORT}" \
  --name $CONTAINER_NAME \
  $IMAGE_NAME
```

æ¥ä¸‹ä¾†å°±èƒ½é€éè…³æœ¬å»ºç½®å¾Œé‹è¡Œï¼š

```shell
./scripts/build-image.sh && ./scripts/run-image.sh
```

## 4. Google Cloud Platform

ç¢ºèªåœ¨æœ¬æ©Ÿé‹è¡Œ container æ²’å•é¡Œå¾Œï¼Œä¸‹ä¸€æ­¥å°±æ˜¯è¦è®“å…¨ä¸–ç•Œèƒ½å¤ çœ‹åˆ°æˆ‘å€‘çš„ç¶²ç«™ï¼åŸºæœ¬ä¸Šä¸å¯èƒ½ç‚ºäº†æ­å»ºé€™å€‹ç¶²ç«™å°±å»è‡ªå»ºæ©Ÿæˆ¿è™•ç†è¨­å‚™ã€ç¶²è·¯ã€å„²å­˜ã€æ•ˆèƒ½ã€å‚™ä»½ã€å®‰å…¨æ€§ç­‰å•é¡Œï¼Œæ‰€ä»¥é€™è£¡é¸æ“‡ä½¿ç”¨ [Google Cloud Platform](https://cloud.google.com/gcp)ï¼ˆä»¥ä¸‹ç°¡ç¨± GCPï¼‰ æä¾›çš„æœå‹™ï¼Œå”åŠ©æˆ‘å€‘æ•´åˆ CI/CD è‡ªå‹•é€²è¡Œå»ºç½®ã€æ¸¬è©¦ã€éƒ¨ç½²è‡³é›²ç«¯ï¼Œè®“æˆ‘å€‘æœ‰æ›´å¤šé¤˜åŠ›å°ˆæ³¨åœ¨é–‹ç™¼ä¸Šã€‚

é–‹å§‹ä½¿ç”¨å‰è¦å…ˆå»ºç«‹ GCP çš„ [project](https://cloud.google.com/resource-manager/docs/creating-managing-projects) ä¸¦ä¸”è¨­å®šå¥½ä»˜æ¬¾è³‡è¨Šï¼Œæ¥è‘—ä¸‹è¼‰ [Google SDK](https://cloud.google.com/sdk/docs/install) å³å¯åœ¨æœ¬æ©Ÿé€²è¡Œæ“ä½œï¼Œå®˜ç¶²æœ‰è©³ç´°æ–‡ä»¶ï¼Œé€™è£¡ä¸å†è´…è¿°ã€‚

### 4.1 Artifact Registry

[Artifact Registry](https://cloud.google.com/artifact-registry) è®“ä½ èƒ½å¤ å„²å­˜ Docker image æˆ–å„ç¨®èªè¨€çš„ packageï¼Œå¦‚ï¼šnpmã€ mavenã€python ç­‰ï¼Œä¸¦ä¸”èƒ½å¤ è¼•é¬†å’Œå…¶ä»– GCP æœå‹™å¦‚ Cloud Buildã€Cloud Run æ•´åˆã€‚

é€™è£¡æˆ‘å€‘æ–°å¢ä¸€å€‹ repositories ä¸¦æŒ‡å®š `--repository-format=docker`ï¼š

```shell
gcloud artifacts repositories create web-repo \
  --repository-format=docker \
  --location=asia-east1
```

åˆ—å‡ºæ‰€æœ‰ repositoriesï¼Œæ‡‰è©²å¯ä»¥çœ‹åˆ°å‰›å‰›æ–°å¢çš„ repositoriesï¼Œæ¥ä¸‹ä¾†æˆ‘å€‘çš„ Docker image éƒ½æœƒå­˜æ”¾åœ¨é€™è£¡ï¼š

```shell
gcloud artifacts repositories list
```

ä¹Ÿå¯ä»¥è‡³ [Artifact Registry Console](https://console.cloud.google.com/artifacts) ç€è¦½æ‰€æœ‰ repositories å’Œåº•ä¸‹çš„ Docker imagesï¼š
![Artifact Registry Console](../images/gcp-static-site/artifact-registry_console.png)

ç”±æ–¼ Artifact Registry æ˜¯ä¸èƒ½è¢«æ‰€æœ‰äººä»»æ„å­˜å–çš„ï¼Œæœ¬æ©Ÿè¦å­˜å–é€™äº› Docker image å¿…é ˆé€²è¡Œä»¥ä¸‹[è¨­å®š](https://cloud.google.com/sdk/gcloud/reference/auth/configure-docker)ï¼š

```shell
gcloud auth configure-docker asia-east1-docker.pkg.dev
```

è¨ˆè²»æ–¹å¼åƒè€ƒ [Artifact Registry Pricing](https://cloud.google.com/artifact-registry/pricing#pricing_overview)ï¼ŒåŸºæœ¬ä¸Šåªè¦éµå®ˆä»¥ä¸‹å¹¾é»å°±ä¸æœƒæœ‰è²»ç”¨ç”¢ç”Ÿï¼š

1. é¿å…ä½¿ç”¨è¶…é 0.5 GB çš„ Storageã€‚
2. Google ç”¢å“å…§éƒ¨ç¶²è·¯è¼¸å‡ºä¸è¦è·¨å€åŸŸã€‚
3. ä¸è¦ç”¢ç”Ÿ Google ç”¢å“å¤–éƒ¨çš„ç¶²è·¯è¼¸å‡ºã€‚

### 4.2 Cloud Build

[Cloud Build](https://cloud.google.com/build) æ˜¯å”åŠ©æˆ‘å€‘æŒçºŒå»ºæ§‹ã€æ¸¬è©¦å’Œéƒ¨ç½²çš„ CI/CD æœå‹™ï¼Œé€éè¨­å®š [Cloud Build configuration file](https://cloud.google.com/build/docs/build-config-file-schema) å…§çš„ `steps` æŒ‡æ® Cloud Build å®Œæˆä»»å‹™ã€‚[è²»ç”¨](https://cloud.google.com/build/pricing)æ–¹é¢åªè¦æ˜¯ä½¿ç”¨é è¨­çš„æ©Ÿå™¨å³äº«æœ‰æ¯æ—¥ 120 åˆ†é˜å…è²»é¡åº¦ã€‚

#### 4.2.1 Local Manual Build

é€šå¸¸ç¿’æ…£å°‡è¨­å®šæª”å–å `cloudbuild.yaml` ä¸¦æ”¾åœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„ï¼Œä»¥ä¸‹ç°¡å–®è§£é‡‹å„æ¬„ä½ä½œç”¨ï¼š

- `steps`ï¼šæŒ‡å®š Cloud Build çš„ä»»å‹™ï¼Œæ¯å€‹æ­¥é©Ÿéƒ½æ˜¯ç”± `docker run` ä¾†åŸ·è¡Œã€‚
- `name` ï¼šæŒ‡å®šè¦ä½¿ç”¨ä»€éº¼ [cloud builder](https://cloud.google.com/build/docs/cloud-builders)ï¼Œé€™äº› cloud builder éƒ½æ˜¯ container imageã€‚
- `args` ï¼šæŒ‡å®š cloud builder åŸ·è¡Œçš„åƒæ•¸ã€‚
- `images`ï¼šæŒ‡å®š images åç¨±ï¼Œåœ¨æ‰€æœ‰ steps å®Œæˆå¾Œæœƒè‡ªå‹• push è‡³ Artifact Registry å„²å­˜ã€‚
- `${PROJECT_ID}`ï¼šåŸ·è¡Œæ™‚ä»£æ›ç‚ºç›®å‰çš„ `PROJECT_ID`ï¼Œåƒè€ƒ [Default Substitutions](https://cloud.google.com/build/docs/configuring-builds/substitute-variable-values#using_default_substitutions)ã€‚
- `${REVISION_ID}`ï¼šåœ¨ Cloud Build åŸ·è¡Œæ™‚ä»£æ›æˆ Trigger å»ºç½®çš„ Git Commit SHAï¼Œåƒè€ƒ [Default Substitutions](https://cloud.google.com/build/docs/configuring-builds/substitute-variable-values#using_default_substitutions)ã€‚

`cloudbuild.yaml`ï¼š

```yaml
steps:
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '--build-arg=REVISION_ID=${REVISION_ID}'
      - '--build-arg=NGINX_PORT=${_NGINX_PORT}'
      - '--tag=asia-east1-docker.pkg.dev/${PROJECT_ID}/vue-landing-page-repo/vue-landing-page:latest'
      - '--file=./build/Dockerfile'
      - '.'
images:
  - 'asia-east1-docker.pkg.dev/${PROJECT_ID}/vue-landing-page-repo/vue-landing-page:latest'
```

æ¥è‘—ä½¿ç”¨ [gcloud builds submit](https://cloud.google.com/sdk/gcloud/reference/builds/submit) æŒ‡ä»¤ï¼Œå°‡å»ºç½® Docker image çš„ä»»å‹™æäº¤çµ¦ Cloud Buildã€‚è€æ¨£å­ï¼Œç‚ºäº†é¿å…æŒ‡ä»¤è½è½é•·ï¼Œæˆ‘å€‘æ’°å¯« `cloud-build.sh` è…³æœ¬æ–¹ä¾¿æœ¬æ©Ÿé€²è¡Œæ¸¬è©¦ï¼š

```shell
#!/bin/bash

set -ex

REVISION_ID="$(git log -1 --format=%H)"
SH_DIR="$(cd "$(dirname "$0")"; pwd -P)"
ROOT_DIR=$(dirname $SH_DIR)
BUILD_DIR="${ROOT_DIR}/build"

source ${BUILD_DIR}/build-image.properties

cd $ROOT_DIR
gcloud builds submit \
  --config cloudbuild.yaml \
  --substitutions=REVISION_ID=${REVISION_ID}
```

åŸ·è¡Œè…³æœ¬å»ºç½®å®Œæˆå¾Œï¼Œå°±å¯ä»¥åˆ° [Viewing build logs](https://console.cloud.google.com/cloud-build/builds)é€™è£¡æŸ¥çœ‹ build resultsï¼š
![Cloud Build Console](../images/gcp-static-site/cloud-build-console.png)

è‹¥æœ‰ performance ä¸Šçš„è€ƒé‡éœ€ä½¿ç”¨ Docker image cacheï¼Œå¯ä»¥é–±è®€å®˜æ–¹é€™ç¯‡ [Best practices for speeding up builds](https://cloud.google.com/build/docs/speeding-up-builds)ï¼Œå…¶ä¸­çš„ [Using a cached Docker image](https://cloud.google.com/build/docs/speeding-up-builds#using_a_cached_docker_image) æ–¹æ³•ç”¨åœ¨ multi-stage çš„å»ºç½®æœƒé‡åˆ°ç„¡æ³•å®Œå…¨åˆ©ç”¨ cache çš„å•é¡Œï¼Œéœ€è¦æ‹†åˆ†æˆå¤šé¡† imageï¼Œåƒè€ƒ [garethr/multi-stage-build-example/cloudbuild.yaml](https://github.com/garethr/multi-stage-build-example/blob/master/cloudbuild.yaml)ã€‚

#### 4.2.2 Trigger Cloud Build by Github Push Event

æˆ‘å€‘ä¸å¸Œæœ›æ¯æ¬¡éƒ½ç”±æ‰‹å‹•ä¾†è§¸ç™¼ Cloud Buildï¼Œæ‡‰è©²è¦å°‡æµç¨‹è‡ªå‹•åŒ–ï¼Œç•¶ç¨‹å¼ç¢¼é€šéæ¸¬è©¦å’Œ review é€²åˆ° master branch å¾Œé¦¬ä¸Šè§¸ç™¼ã€‚Triggerï¼ˆè§¸ç™¼æ¢ä»¶ï¼‰ èƒ½å¤ æ ¹æ“š push to a branchã€push new tag ä»¥åŠ pull request ç­‰ event è§¸ç™¼ Cloud Build åŸ·è¡Œï¼Œå’Œ Github çš„æ•´åˆå®˜æ–¹æœ‰[è©³ç´°çš„æ­¥é©Ÿ](https://cloud.google.com/build/docs/automating-builds/build-repos-from-github)ï¼Œé€™è£¡ä¸å†è´…è¿°ã€‚

![Cloud Build Trigger](../images/gcp-static-site/cloud-build-trigger.png)

### 4.3 Cloud Run

[Cloud Run](https://cloud.google.com/run) æ˜¯ GCP æä¾›çš„ [serverless](https://cloud.google.com/serverless) æœå‹™ï¼Œåªéœ€é€é yaml è¨­å®šå³å¯éƒ¨ç½²ã€é‹è¡Œ containerized appï¼Œå®Œå…¨ä¸éœ€ç®¡ç† server infrastructureï¼Œè®“æˆ‘å€‘èƒ½å°ˆæ³¨åœ¨é–‹ç™¼ä¸Šã€‚å®ƒå…·å‚™ [autoscaling](https://en.wikipedia.org/wiki/Autoscaling) çš„èƒ½åŠ›ï¼Œæ ¹æ“šç•¶ä¸‹ traffic ä¾†åˆ†é…è¨ˆç®—è³‡æºï¼Œåœ¨æ²’æœ‰ request æ™‚ scale-to-zeroã€‚é€™æ„å‘³è‘—æˆ‘å€‘çš„ç¶²ç«™ [handle request æ™‚æ‰è¨ˆè²»](https://cloud.google.com/run/pricing#billable-time)ï¼š

```text
          request1            response1
                |   request2     ÊŒ      response2
                |        |       |       ÊŒ
                v........|......./       |
                         |               |
                         v.............../

|-----FREE-----|----------BILLED----------|----FREE...
```

ä»¥ä¸Šåœ–è¡¨ç¯€éŒ„è‡ª [Google Cloud Run - FAQ](https://github.com/ahmetb/cloud-run-faq) by [Ahmet Alp Balkan](https://github.com/ahmetb) ï¼Œlicensed under [Creative common Attribution 4.0 International (CC BY 4.0)](https://creativecommons.org/licenses/by/4.0/) ã€‚æœ€æ–°ã€æœ€è©³ç´°çš„è¨ˆè²»æ–¹å¼è«‹ä»¥å®˜æ–¹ [Cloud Run Pricing](https://cloud.google.com/run/pricing) ç‚ºæº–ã€‚

å¯ä»¥çœ‹åˆ°ç•¶æ²’æœ‰ç¶²è·¯è«‹æ±‚æ™‚ï¼Œé‹è¡Œçš„ container æ•¸é‡ç‚º 0ï¼š
![autoscaling](../images/gcp-static-site/autoscaling.png)

å“‡ï¼è½èµ·ä¾†å¥½æ£’æ£’ï¼ä¸éä¹Ÿæœ‰å¹¾é»å€¼å¾—æ³¨æ„ï¼š

1. [cold start](https://github.com/ahmetb/cloud-run-faq#cold-starts)ï¼šå¦‚æœé•·æ™‚é–“æ²’æœ‰æ¥æ”¶åˆ°è«‹æ±‚ï¼Œé‚£éº¼ä¸‹ä¸€æ¬¡è«‹æ±‚æœƒæœ‰é¡å¤–çš„å»¶é²ã€‚ä¸éé€™å°æ–¼æˆ‘å€‘å–®ç´”çš„éœæ…‹ç¶²ç«™å¹¾ä¹ä¸æœƒé€ æˆä»€éº¼å½±éŸ¿ã€‚
2. `WebSocket`ï¼šç”±æ–¼ WebSocket é€£ç·šæ˜¯é•·æ™‚é–“æŒçºŒçš„ï¼Œå¯èƒ½æœƒå°è‡´ç”¨é‡å¢åŠ ï¼Œä½ è¦èŠ±çš„éŒ¢éŒ¢ä¹Ÿå°±è®Šå¤šäº†ï¼é‚„æœ‰å¾ˆå¤šçœ‰çœ‰è§’è§’å»ºè­°ç›´æ¥åƒè€ƒå®˜æ–¹æ–‡ä»¶ï¼š[Using WebSockets](https://cloud.google.com/run/docs/triggering/websockets)ã€‚

æ¥ä¸‹ä¾†åœ¨ `cloudbuild.yaml` åŠ å…¥æ–°çš„ `steps`ï¼ŒæˆåŠŸ build image å¾Œä½¿ç”¨ [Cloud SDK](https://github.com/GoogleCloudPlatform/cloud-sdk-docker) image éƒ¨ç½²è‡³ Cloud Runï¼š

```yaml
steps:
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '--build-arg=REVISION_ID=${REVISION_ID}'
      - '--tag=asia-east1-docker.pkg.dev/${PROJECT_ID}/vue-landing-page-repo/vue-landing-page:latest'
      - '--file=./build/Dockerfile'
      - '.'
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - 'vue-landing-page-service'
      - '--image=asia-east1-docker.pkg.dev/${PROJECT_ID}/vue-landing-page-repo/vue-landing-page'
      - '--region=asia-east1'
      - '--platform=managed'
images:
  - 'asia-east1-docker.pkg.dev/${PROJECT_ID}/vue-landing-page-repo/vue-landing-page:latest'
```

æ¥ä¸‹ä¾†åªéœ€è¦é€éç¶“ç¨‹å¼ç¢¼ pushã€merge è‡³ Github master branchï¼Œå°±æœƒè‡ªå‹•è§¸ç™¼ Cloud Build ä¸¦ä¸”éƒ¨ç½²è‡³ Cloud Runã€‚

## 5. çµèª

é€™æ¬¡ä¸»è¦æ˜¯ä½œç‚º**ç·´ç¿’ç”¨é€”**ï¼Œåœ¨å·¥ä½œä¸Šå¾ˆé›£æœ‰æ‰€è¬‚çš„ã€Œç´”å‰ç«¯å·¥ç¨‹å¸«ã€ğŸ™„ï¼Œå„å¼å„æ¨£çš„æŠ€è¡“éƒ½æ‡‰æ¶‰ç•¥ï¼Œå¯ä»¥æ¸›å°‘å¾€å¾Œå’Œå¾Œç«¯ã€SRE å°å¤¥ä¼´å”ä½œæºé€šçš„æˆæœ¬ã€‚

åœ¨æœå‹™çš„é¸æ“‡ä¸Šï¼Œåƒ…å–®ç´”è¦éƒ¨ç½²éœæ…‹ç¶²ç«™ä¸”ä¸éœ€è¦é€²è¡Œè¤‡é›œè¨­å®šçš„è©±ï¼Œæˆ‘æœƒå„ªå…ˆé¸æ“‡ [Netlify](https://www.netlify.com/)ï¼Œä½¿ç”¨æ›´ç‚ºç°¡å–®ã€è¼•é¬†æ•´åˆ CI/CDã€ä»¥åŠ [Deploy Previews](https://docs.netlify.com/site-deploys/deploy-previews/) çš„åŠŸèƒ½ï¼Œå¦‚æœ¬ Blog å°±æ˜¯ä½¿ç”¨ Netlify æä¾›çš„æœå‹™é€²è¡Œå»ºç½®å’Œéƒ¨ç½²ã€‚å¦å¤–é‚„æœ‰å…¶ä»–é¸é …ï¼Œå¦‚ [Firebase Hosting](https://firebase.google.com/docs/hosting)ã€‚

éƒ¨ç½²å®Œäº†é‚„éœ€è¦ [Custom Domain](https://cloud.google.com/run/docs/mapping-custom-domain)ã€åˆ©ç”¨ [Cloud Logging](https://cloud.google.com/logging) ç›£æ§ä»¥åŠçŸ¥é“å‡ºäº‹æ™‚è¦æ€éº¼ [Rollback](https://cloud.google.com/run/docs/rollouts-rollbacks-traffic-migration)ï¼Œç¤™æ–¼ç¯‡å¹…ç•™åˆ°ä¸‹ä¸€ç¯‡æ–‡ç« å†ä»‹ç´¹ã€‚

## 6. åƒè€ƒè³‡æ–™

é™¤å®˜æ–¹æ–‡ä»¶å¤–ï¼Œæ’°å¯«æœ¬ç¯‡æ–‡ç« æ™‚åƒè€ƒäº†ä»¥ä¸‹è³‡æºï¼š

1. [Optimizing Encoding and Transfer Size of Text-Based Assets](https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/optimize-encoding-and-transfer)
2. [ç”¨åŸºç¤é›²ç«¯æ¦‚å¿µä¾†äº†è§£ GCP çš„å¥½](https://www.mile.cloud/zh/resources/blog/44/%E7%94%A8%E5%9F%BA%E7%A4%8E%E9%9B%B2%E7%AB%AF%E6%A6%82%E5%BF%B5%E4%BE%86%E4%BA%86%E8%A7%A3%2520GCP%2520%E7%9A%84%E5%A5%BD)
3. [CI/CD (æŒçºŒæ€§æ•´åˆ / éƒ¨ç½²) - å› ç‚ºæ‡¶ï¼Œæ‰€ä»¥æ›´è¦ CI/CDï¼æ¦‚å¿µè¬›è§£ï¼ | Kennyâ€™s Blog](https://blog.kennycoder.io/2020/04/07/CI-CD-%E6%8C%81%E7%BA%8C%E6%80%A7%E6%95%B4%E5%90%88-%E9%83%A8%E7%BD%B2-%E5%9B%A0%E7%82%BA%E6%87%B6%EF%BC%8C%E6%89%80%E4%BB%A5%E6%9B%B4%E8%A6%81CI-CD%EF%BC%81%E6%A6%82%E5%BF%B5%E8%AC%9B%E8%A7%A3%EF%BC%81/)
4. [Journey to Serverless on Google Cloud Platform | by Timothy | Google Cloud - Community | Medium](https://medium.com/google-cloud/journey-to-serverless-on-google-cloud-platform-67b8d392ffa2)
5. [GitHub - ahmetb/cloud-run-faq: Unofficial FAQ and everything youâ€™ve been wondering about Google Cloud Run.](https://github.com/ahmetb/cloud-run-faq#are-websockets-supported-on-cloud-run)
6. [GitHub - steren/awesome-cloudrun: ğŸ‘“ â© A curated list of resources about all things Cloud Run](https://github.com/steren/awesome-cloudrun)
