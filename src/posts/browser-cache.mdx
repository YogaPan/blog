---
title: 'å‰ç«¯ Cache ç­†è¨˜'
date: '2020-01-01'
tags: ['HTTP']
---

## Table of Contents

```toc
```

## Expires, Cache-Control, max-age

ä»¥ä¸‹ç¯„ä¾‹ä¸­ Expires ç‚ºäº†é–±è®€æ–¹ä¾¿ï¼Œæ ¼å¼æœ‰ç¨ä½œä¿®æ”¹ ğŸ˜œï¼Œå¯¦éš›ä¸Š Expires çš„æ ¼å¼æœƒåƒæ˜¯é€™æ¨£ï¼š `Expires: Wed, 21 Oct 2017 07:28:00 GMT`

### Case 1

å‡è¨­ç¾åœ¨æ™‚é–“ `2020-01-01 00:00:00`ï¼ŒClient ç¬¬ä¸€æ¬¡è«‹æ±‚ `index.html` çš„è³‡æºï¼Œ
Server å›æ‡‰ Headerï¼š

```http
Cache-Control: max-age=3600
```

- åœ¨ `2020-01-01 00:00:00` + 3600 ç§’ = `2020-01-01 01:00:00` ä»¥å‰è«‹æ±‚ `index.html`ï¼Œç€è¦½å™¨éƒ½æœƒç›´æ¥æ‹¿ Cache çš„è³‡æºï¼Œè€Œä¸å‘ Server ç™¼å‡º Requestã€‚
- `2020-01-01T01:00:00Z` ä»¥å¾Œè«‹æ±‚ `index.html`ï¼Œæœƒé‡æ–°ç™¼å‡º request

### Case 2

Server å›æ‡‰ Headerï¼š

```http
Expires: 2020-01-01 12:00:00
```

- åœ¨ `2020-01-01 12:00:00` ä»¥å‰è«‹æ±‚ `index.html`ï¼Œç€è¦½å™¨éƒ½æœƒç›´æ¥æ‹¿ Cache çš„è³‡æºï¼Œè€Œä¸å‘ Server ç™¼å‡º Requestã€‚
- åœ¨ `2020-01-01 12:00:00` ä»¥å¾Œè«‹æ±‚ `index.html`ï¼Œæœƒé‡æ–°ç™¼å‡º request

### Case 3

Server å›æ‡‰ Headerï¼š

```http
Expires: 2020-01-01 01:00:00
Cache-Control: max-age=7200
```

æ ¹æ“š [RFC2616](https://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.9.3): If a response includes both an Expires header and a max-age directive, the max-age directive overrides the Expires header, even if the Expires header is more restrictive

å³ä½¿ Expires çš„æ™‚é–“æ¯” Cache-Control çš„æ™‚é–“æ›´æ—©ï¼Œä½†æ˜¯é€™è£ä¾ç„¶ä»¥ Cache-Control çš„æ™‚é–“ç‚ºæº–ã€‚

### é‡é»æ•´ç†

- é‚„æ²’è¶…é Expire æˆ–è€…æ˜¯åœ¨ max-age è¦å®šçš„æœŸé™ï¼Œå°±ç›´æ¥å¾å¿«å–è£¡é¢æ‹¿è³‡æ–™ã€‚å¦‚æœéæœŸäº†å°±ç™¼é€ Request å»è·Ÿ Server æ‹¿æ–°çš„è³‡æ–™ã€‚
- Expires å¾Œé¢é¡¯ç¤ºå…·é«”æ™‚é–“ï¼ŒCache-Control å¾Œåˆ©ç”¨ max-age æŒ‡å®šæ™‚é–“é–“éš”ï¼Œå–®ä½ç‚ºç§’
- Cache-Control æœƒè¦†è“‹æ‰ Expiresï¼Œå³ä½¿ Expires çš„æ™‚é–“æ¯” Cache-Control çš„ max-age æ›´æ—©

## Last-Modified, If-Modified-Since

Server Response

```http
Last-Modified: 2017-01-01 13:00:00
Cache-Control: max-age=31536000
```

### Case 1

ä¸€å¹´å…§çš„è«‹æ±‚éƒ½æœƒåˆ©ç”¨ Browser çš„ Cacheã€‚

### Case 2

ç¶“éä¸€å¹´å¾Œï¼ŒClient ç™¼å‡º Request

```http
GET /logo.png
If-Modified-Since: 2017-01-01 13:00:00
```

å¦‚æœæª”æ¡ˆåœ¨ `2017-01-01 13:00:00` æœ‰å†æ›´æ”¹éï¼ŒServer å°±æœƒå†å›ä¸€ä»½æ–°çš„æª”æ¡ˆï¼Œä¸¦ä¸”è¨­å®š Cacheï¼š

```http
Last-Modified: 2017-07-01 13:00:00
Cache-Control: max-age=31536000
```

### Case 3

ç¶“éä¸€å¹´å¾Œï¼ŒClient ç™¼å‡º Request

```http
GET /logo.png
If-Modified-Since: 2017-01-01 13:00:00
```

å¦‚æœæª”æ¡ˆåœ¨ `2017-01-01 13:00:00` ä»¥å¾Œæ²’æœ‰æ›´æ”¹éï¼ŒServer æœƒå›æ‡‰ `Status code: 304 (Not Modified)`ï¼Œä»£è¡¨å¿«å–è£¡é¢çš„è³‡æºé‚„èƒ½ç¹¼çºŒæ²¿ç”¨ã€‚

## Etag, If-None-Match

å¯ä»¥æŠŠ Etag æƒ³æˆæ˜¯é€™ä»½æª”æ¡ˆå…§å®¹çš„ hash å€¼ï¼ˆä½†å…¶å¯¦ä¸æ˜¯ï¼Œä½†æ˜¯åŸç†ç›¸è¿‘ï¼‰ï¼Œåˆ©ç”¨æª”æ¡ˆå…§å®¹æ›´å‹•èˆ‡å¦ä¾†ç•¶ä½œæ˜¯å¦æ›´æ–°å¿«å–çš„æ¢ä»¶ã€‚

![ETag](../images/browser-cache/001.png)

## no-store, no-cache

Q: å¦‚æœæˆ‘æƒ³è¦æª”æ¡ˆæœ‰æ›´å‹•å°±èƒ½å¤ é¦¬ä¸Šå¾—çŸ¥è©²æ€éº¼åšå‘¢ï¼Ÿ
A: æ¯æ¬¡è«‹æ±‚éƒ½å• Server æª”æ¡ˆæ˜¯å¦æœ‰æ›´å‹•ï¼Œå¦‚æœæœ‰æ›´å‹•å‰‡å›æ‡‰æ–°çš„è³‡æºï¼Œå¦å‰‡å›æ‡‰ `status code: 304 (Not Modified)`

### Example

```http
Cache-Control: max-age=0
Etag: 1234
```

æˆ–è€…

```http
Cache-Control: no-cache
Etag: 1234
```

å®Œå…¨ä¸ä½¿ç”¨å¿«å–

```http
Cache-Control: no-store
```

### é‡é»æ•´ç†

- **no-cache**: æ¯æ¬¡éƒ½æœƒç™¼é€ Request å»ç¢ºèªæª”æ¡ˆæ˜¯å¦æ›´å‹•
- **no-store**: å®Œå…¨ä¸ä½¿ç”¨å¿«å–

## Long Term Cache

åƒè€ƒï¼šhttps://developers.google.com/web/fundamentals/performance/webpack/use-long-term-caching

Q: æœ‰æ²’æœ‰è¾¦æ³•èƒ½å¤ ç”šè‡³é€£è«‹æ±‚éƒ½ä¸ç™¼ï¼Œä½†æ˜¯å»èƒ½å¤ çŸ¥é“æª”æ¡ˆå·²ç¶“æ›´å‹•äº†å‘¢ï¼Ÿ
A: å°‡ Etag çš„æ©Ÿåˆ¶è‡ªå·±å¯¦ä½œåœ¨æª”åè£¡

### Example

ç¾åœ¨è¨±å¤šç¶²ç«™éƒ½æ˜¯æ¡ç”¨ SPA çš„æ¶æ§‹æ­é… Webpack æ‰“åŒ…ã€‚å‰ç«¯åªéœ€è¦å¼•å…¥ä¸€å€‹ JavaScript çš„æª”æ¡ˆï¼š

```html
<!DOCTYPE html>
<html>
<head>
  <link rel='stylesheet' href='style.css'></link>
  <script src='script.js'></script>
</head>
<body>
  <!-- body is render by js -->
</body>
</html>
```

js æª”ååŠ ä¸Š Hash:

```html
<!DOCTYPE html>
<html>
<head>
  <link rel='stylesheet' href='style.css'></link>
  <script src='script-fgi81ksdff.js'></script>
</head>
<body>
  <!-- body is render by js -->
</body>
</html>
```

JavaScript çš„æª”åè®Šæˆï¼š`script-fgi81ksdff.js`ï¼Œå…¶å¯¦å°±è·Ÿ Etag ä¸€æ¨£ï¼Œéƒ½æ˜¯ä»£è¡¨é€™å€‹æª”æ¡ˆçš„ hash å€¼ã€‚ç„¶å¾Œæˆ‘å€‘æŠŠé€™å€‹æª”æ¡ˆçš„å¿«å–ç­–ç•¥è¨­æˆï¼š

```http
Cache-Control: max-age=31536000ã€‚
```

é€™æ¨£å­é€™å€‹æª”æ¡ˆå°±æœƒè¢«å¿«å–ä½ä¸€å¹´ã€‚ä¸€å¹´ä¹‹å…§éƒ½ä¸æœƒå°é€™å€‹ URL ç™¼é€æ–°çš„ Requestã€‚

è—‰ç”±æŠŠ Etag çš„æ©Ÿåˆ¶å¯¦ä½œåœ¨ `index.html` è£¡é¢ï¼Œæˆ‘å€‘å°±é”æˆäº†æˆ‘å€‘çš„ç›®æ¨™ï¼šã€Œåªè¦æª”æ¡ˆä¸æ›´æ–°ï¼Œç€è¦½å™¨å°±ä¸æœƒç™¼ Requestï¼Œç›´æ¥æ²¿ç”¨å¿«å–ã€‚åªè¦æª”æ¡ˆä¸€æ›´æ–°ï¼Œç€è¦½å™¨å°±è¦ç«‹å³æŠ“å–æ–°çš„æª”æ¡ˆã€ã€‚åŸç†å°±æ˜¯é‡å°ä¸åŒçš„æª”æ¡ˆæ¡ç”¨ä¸åŒçš„å¿«å–ç­–ç•¥ï¼Œä¸¦ä¸”ç›´æ¥ç”¨ã€Œæ›´æ› JavaScript æª”æ¡ˆã€çš„æ–¹å¼å¼·åˆ¶ç€è¦½å™¨é‡æ–°ä¸‹è¼‰ã€‚

![filehash](../images/browser-cache/002.png)

## ç¸½çµ

`Expires` è·Ÿ `max-age` æ˜¯åœ¨è² è²¬çœ‹é€™å€‹å¿«å–æ˜¯ä¸æ˜¯ã€Œæ–°é®®ã€ï¼Œ`Last-Modified`, `If-Modified-Since`, `Etag`, `If-None-Match` æ˜¯è² è²¬è©¢å•é€™å€‹å¿«å–èƒ½ä¸èƒ½ã€Œç¹¼çºŒä½¿ç”¨ã€ï¼Œè€Œ `no-cache` èˆ‡ `no-store` å‰‡æ˜¯ä»£è¡¨åˆ°åº•è¦ä¸è¦ä½¿ç”¨å¿«å–ï¼Œä»¥åŠæ‡‰è©²å¦‚ä½•ä½¿ç”¨ã€‚

## å¾…è§£æ±ºå•é¡Œ

- From Memory Cache vs From Disk Cache
- Cache Control Default Value
- BF Cache

## åƒè€ƒè³‡æ–™

- [HTTP/1.1: Header Field Definitions](https://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.9.1)
- [Cache-Control - HTTP | MDN](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control)
- [HTTP Caching Â |Â  Web Fundamentals Â |Â  Google Developers](https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/http-caching?hl=en)
- [å¾ªåºæ¼¸é€²ç†è§£ HTTP Cache æ©Ÿåˆ¶](https://blog.techbridge.cc/2017/06/17/cache-introduction/)
- [æ–°æ‰‹å‘ï¼šè®“äººåˆæ„›åˆæ¨çš„ HTTP Caching - Frochu - Medium](https://medium.com/frochu/http-caching-3382037ab06f)

### Long Term Cache

- [Make use of long-term caching |Â Web FundamentalsÂ |Â Google Developers](https://developers.google.com/web/fundamentals/performance/webpack/use-long-term-caching)
- [å¤§å…¬å¸é‡Œæ€æ ·å¼€å‘å’Œéƒ¨ç½²å‰ç«¯ä»£ç ï¼Ÿ Â· Issue #6 Â· fouber/blog](https://github.com/fouber/blog/issues/6)